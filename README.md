# BICI_SENSORS_ROS
This repository is for: 

1- the code needed to read the BICI sensors data and communicate them in ROS and other related software

2- the code needed to control the allegro hand

**P.S.** The proximal back and proximal front sensors of the thumb must be removed from the I2C network and the codes that use them (i.e. coordinates_listener.cpp) before programming and working with the pcbs to be soldered in the future.

**Allegro ROS Communication Package**

In order to download the setup the packages needed to communicate with the Allegro Hand, please execute the following shell scripts in order and follow the instructions as prompted:

1- Pcan_Downloads

2- Pcan_Bus_Setup

**P.S.** In order to read data from the tactile sensors, the USB serial communication must be setup by using the following command: sudo chmod 777 /dev/ttyUSB0 or sudo chmod 777 /dev/ttyUSB1

**P.S.** After building everything in ROS_COMM_WS using catkin, the following command will initiate the torque control of the Allegro hand, as well as contact visualization/recording: roslaunch allegro_hand_controllers allegro_hand.launch HAND:=right CONTROLLER:=torque VISUALIZE:=true

**P.S.** In order to torque control the joints of the Allegro hand, use the following command: rostopic pub -1 /allegroHand_0/torque_cmd sensor_msgs/JointState "{effort: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0 ,0 ,0]}"

where each number correspond to a joint as per the instructions provided in the "Allegro_Torque_Control_Guide.pdf" file in the ROS_WS directory of the repository.

**P.S.** All the models used in Gazebo simulation (along with their meshes) are stored in the "models" folder under the "Gazebo_Simulation" directory. Before running the simulation make sure to move this folder into "~/.gazebo".

**P.S.** When building ROS_WS (for the first time), "bici_ros_sensor_reader" package must be built first using the command: catkin_make --only-pkg-with-deps <target_package> , then switching back to building all the packages is needed using this command: catkin_make -DCATKIN_WHITELIST_PACKAGES="". Moreover, the copy all the files generated by cmake during the build process into the central directory, which is in this case: **/opt/ros/noetic** (that can be recognized by any other IDE and this can be useful if you want to include and use a package that you have already built inside a code in a certain IDE), use the following set of commands:

`sudo su`

`source /opt/ros/noetic/setup.bash`

`source /home/abed/Documents/BICI_Project/BICI_SENSORS_ROS/ROS_WS/devel/setup.bash`

`catkin_make -DCMAKE_INSTALL_PREFIX=/opt/ros/noetic install`

**P.S.** The coordinates_listener node should be run separately from the allegro_hand.launch file (should be working toward including it in the launch file) and from the ROW_WS directory.

**Robot Arm Workspace Building Notes**

    **P.S.** Before building any package, run the following two commands:

       - rosdep update

       - rosdep install --rosdistro noetic --ignore-src --from-paths src --os=ubuntu:focal

    **P.S.** To clone a branch, you have to use the following command:
        git clone -b "branch-name" --single-branch "repo-link"

    1- In case of a PC format, before building robotiq package, run the following command:
        sudo apt install ros-noetic-soem

    2- When building coro_workstations package, clone the robotiq_85_gripper separately inside the coro_workstations package (this is because  robotiq_85_gripper is used as a submodule inside the coro_workstations repo) 

**Required steps for UR5-e hardware control via Moveit**
    
    0- Make sure to connect the UR5e controller directly to an internet socket using the ethernet cable and connect your PC via ethernet cable to the router next to the UR5e workstation, after that disable the wirless connection on your PC and enable wired connection.

    1- Upper right corner three-dashes button --> settings --> System --> URCaps --> Press the "+" button to add only: "External Control" from usbdisk. Remove the rest of the active URCaps if any and restart the whole system.

    2- Go to Installation --> URCaps --> External Control and put the ip address of your PC under the Host IP space (use `hostname -I` command to discover the ip address of your PC). Use port 50002. Leave Host name as is.

    3- Go to the Run tab (in the upper toolbar) and load ROS.urp (by pressing the "Load Program" button, you can find the .urp file directly in the home directory)
    
    4- Go to the Program tab and add the External Control node under URCaps on the left side panel to Robot Program (which is the ROS.urp file that was loaded earlier)
    
    5- Turn the robot on and start it

    6- Run the command: `roslaunch coro_workstations ur5e_workstation.launch robot_ip:= <"robot ip address as specified in the "About" tab under the three dashes button in the upper right corner of the teach pendant screen">`
    
    7- Press the play button to run the robot program (in this case the previously loaded ROS.urp file)

    8- Control the robotic arm with moveit

    9- In case of a PC format, before running the hardware-related launch file, run the following command: `sudo apt install ros-noetic-moveit-resources-prbt-moveit-config`

**P.S.** In case of a format, how to setup your PC for ROS development:

1- In VScode: Use ctrl + shift + p to open the command palette and search there for "c_cpp_properties.json" then open the file and add the highlighted line of code as it appears in the "VScode_ROS_Setup" image under ROS_WS directory.

2- Install all the needed gazebo_ros packages (this is particularly needed for building the contact sensor plugin in QtCreator)

# SYNTHETIC DATA GENERATION STEPS

1- Use the following command to run the Gazebo simulation environment along with all the necessary controllers and plugins for both the UR5e arm and the allegro hand: `roslaunch coro_workstations ur5e_workstation.launch`

2- Use the following command to run the python script that will command both the robotic arm and hand to systematically conduct the experiments and generate the synthetic data: `rosrun moveit_scripts move_group_python_interface_simulation.py`

3- The generated synthetic data is stored in the folder:"~/Desktop/Contact_Data" (**P.S.** The folder needs to be created manually)

4- Press the play button to run the Gazebo simulation before launching the python script needed to initiate the synthetic data generation experiments




